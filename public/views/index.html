<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Portal</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="landing-page customer-login-page">
    <header class="landing-banner">
        <div class="landing-banner__logo">
            <img src="../images/seco-logo.png" alt="SECO Energy Logo" class="logo" />
        </div>
        <div class="landing-banner__content">
            <h1>Service Portal</h1>
            <p class="lede">Welcome! Please sign in to submit a service request.</p>
        </div>
    </header>

    <div class="customer-login-container">
        <div class="customer-login-card">
            <h2>Customer Sign In</h2>
            <p class="login-subtitle">Enter your credentials to continue</p>
            
            <form id="customer-login-form">
                <label>
                    Username <span class="required">*</span>
                    <input type="text" id="customer-username" required placeholder="Enter your username" autocomplete="username">
                </label>
                
                <label>
                    Password <span class="required">*</span>
                    <input type="password" id="customer-password" required placeholder="Enter your password" autocomplete="current-password">
                </label>
                
                <div id="customer-login-error" class="form-error"></div>
                
                <button type="submit" class="btn-primary login-btn">Sign In</button>
            </form>
            
            <div style="margin-top: 16px; padding: 16px; background: rgba(0, 120, 255, 0.1); border-radius: 8px; border-left: 3px solid #0078ff;">
                <p style="margin: 0 0 8px 0; font-weight: 600; color: #003366; font-size: 14px;">Test Account:</p>
                <p style="margin: 4px 0; color: #555; font-size: 13px;"><strong>customer</strong> / customer123</p>
            </div>
            
            <div class="login-footer">
                <p>Staff members? <a href="/tech-login.html" class="staff-link">Access Staff Portal â†’</a></p>
            </div>
        </div>
    </div>

    <script>
        // Customer login handler
        const loginForm = document.getElementById('customer-login-form');
        const loginError = document.getElementById('customer-login-error');
        const usernameInput = document.getElementById('customer-username');
        const passwordInput = document.getElementById('customer-password');

        // Check if already logged in as customer
        const existingToken = localStorage.getItem('customerAuthToken');
        const existingCustomerInfo = localStorage.getItem('customerInfo');
        if (existingToken && existingCustomerInfo) {
            window.location.href = './landing.html';
        } else {
            // Clear any stale tokens
            localStorage.removeItem('customerAuthToken');
            localStorage.removeItem('customerInfo');
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                loginError.textContent = 'Please enter both username and password.';
                return;
            }

            // Disable button during login
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing in...';

            // Default customer account for local testing
            const defaultCustomerAccount = {
                username: 'customer',
                password: 'customer123',
                fullName: 'Customer User',
                email: 'customer@example.com',
                phone: '(555) 123-4567',
                department: 'General',
                role: 'Customer',
                id: 100
            };

            // Check if running locally (file:// protocol) or if backend is unavailable
            const isLocalMode = window.location.protocol === 'file:';

            if (isLocalMode) {
                // LOCAL MODE: Use hardcoded credentials
                if (username === defaultCustomerAccount.username && password === defaultCustomerAccount.password) {
                    localStorage.setItem("customerAuthToken", "local-customer-token-" + Date.now());
                    localStorage.setItem("customerInfo", JSON.stringify({
                        name: defaultCustomerAccount.fullName,
                        email: defaultCustomerAccount.email,
                        phone: defaultCustomerAccount.phone,
                        department: defaultCustomerAccount.department,
                        username: defaultCustomerAccount.username,
                        id: defaultCustomerAccount.id,
                        loginTime: new Date().toISOString()
                    }));
                    
                    console.warn('ðŸ”§ LOCAL MODE - using hardcoded customer credentials');
                    window.location.href = "./landing.html";
                } else {
                    loginError.textContent = "Invalid credentials. Try: customer/customer123";
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Sign In";
                }
                return;
            }

            // PRODUCTION MODE: Call backend API
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    loginError.textContent = data.error || "Invalid credentials";
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Sign In";
                    return;
                }

                // Verify this is a customer account (not staff)
                if (data.user.role !== 'Customer') {
                    loginError.textContent = "This account is not authorized for customer portal. Staff members should use the staff portal.";
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Sign In";
                    return;
                }

                // Store authentication token and customer info
                localStorage.setItem("customerAuthToken", data.token);
                localStorage.setItem("customerInfo", JSON.stringify({
                    name: data.user.fullName,
                    email: data.user.email || '',
                    phone: data.user.phone || '',
                    department: data.user.department || '',
                    username: data.user.username,
                    id: data.user.id,
                    loginTime: new Date().toISOString()
                }));

                // Redirect to customer landing page
                window.location.href = "./landing.html";

            } catch (error) {
                console.error('Login error:', error);
                
                // FALLBACK: Try hardcoded credentials if API fails
                if (username === defaultCustomerAccount.username && password === defaultCustomerAccount.password) {
                    localStorage.setItem("customerAuthToken", "local-customer-token-" + Date.now());
                    localStorage.setItem("customerInfo", JSON.stringify({
                        name: defaultCustomerAccount.fullName,
                        email: defaultCustomerAccount.email,
                        phone: defaultCustomerAccount.phone,
                        department: defaultCustomerAccount.department,
                        username: defaultCustomerAccount.username,
                        id: defaultCustomerAccount.id,
                        loginTime: new Date().toISOString()
                    }));
                    
                    console.warn('ðŸ”§ FALLBACK MODE - API unavailable, using hardcoded customer credentials');
                    window.location.href = "./landing.html";
                    return;
                }

                loginError.textContent = "Connection error. Try: customer/customer123";
                submitBtn.disabled = false;
                submitBtn.textContent = "Sign In";
            }
        });

        // Allow Enter key to submit
        passwordInput.addEventListener("keyup", e => {
            if (e.key === "Enter") {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
        usernameInput.addEventListener("keyup", e => {
            if (e.key === "Enter") {
                passwordInput.focus();
            }
        });
    </script>
</body>
</html>
